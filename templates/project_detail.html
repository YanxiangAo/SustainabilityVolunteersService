<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Details - Sustainable Volunteer Platform</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
{% macro render_stars(rating, size='20') %}
    {% set rating_int = rating | int %}
    {% set rating_decimal = rating - rating_int %}
    {% set color_class = 'rating-high' if rating >= 4 else ('rating-medium' if rating >= 3 else 'rating-low') %}
    {% set bg_color = '#dcfce7' if rating >= 4 else ('#fef3c7' if rating >= 3 else '#f3f4f6') %}
    <div class="sustainability-rating {{ color_class }}">
        <div class="stars">
            {% for i in range(1, 6) %}
                {% if i <= rating_int or (i == rating_int + 1 and rating_decimal >= 0.5) %}
                    <svg class="star filled" xmlns="http://www.w3.org/2000/svg" width="{{ size }}" height="{{ size }}" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2">
                        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                    </svg>
                {% else %}
                    <svg class="star" xmlns="http://www.w3.org/2000/svg" width="{{ size }}" height="{{ size }}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                    </svg>
                {% endif %}
            {% endfor %}
        </div>
        <span class="rating-badge" style="background-color: {{ bg_color }};">{{ "%.1f"|format(rating) }}</span>
    </div>
{% endmacro %}
    <!-- Header -->
    <header class="header">
        <div class="container header-content">
            <a href="/" class="btn btn-ghost">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 0.5rem;">
                    <line x1="19" y1="12" x2="5" y2="12"/>
                    <polyline points="12 19 5 12 12 5"/>
                </svg>
                Back
            </a>
        </div>
    </header>

    <div class="container py-8">
        <div class="grid grid-cols-3" style="gap: 2rem;">
            <!-- Main Content -->
            <div style="grid-column: span 2;">
                <!-- Project Header -->
                <div class="card mb-6">
                    <div class="card-header">
                        <div class="flex items-start justify-between mb-4">
                            <div style="flex: 1;">
                                <div class="flex items-center gap-3 mb-2">
                                    <span class="badge badge-primary">{{ project.category }}</span>
                                    {% if registration_count %}
                                    <span class="badge" style="background-color: #dbeafe; color: var(--secondary-blue);">Registered</span>
                                    {% endif %}
                                </div>
                                <h1 class="mb-3">{{ project.title }}</h1>
                                <div class="flex items-center gap-2 text-gray-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                                    </svg>
                                    <span>{{ (organization.display_name or organization.username) if organization else 'Organization Name' }}</span>
                                    <span class="badge badge-success">Verified</span>
                                </div>
                            </div>
                            {{ render_stars(project.rating or 0.0, '20') }}
                        </div>
                    </div>
                </div>

                <!-- Project Details -->
                <div class="card mb-6">
                    <div class="card-header">
                        <h3 style="margin: 0;">Project Details</h3>
                    </div>
                    <div class="card-content">
                        <div class="mb-6">
                            <h3 class="mb-2">Description</h3>
                            <p class="text-gray-700" style="line-height: 1.8;">
                                {{ project.description }}
                            </p>
                        </div>

                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <div class="flex items-start gap-3">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: var(--gray-500); margin-top: 0.125rem;">
                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                    <line x1="16" y1="2" x2="16" y2="6"/>
                                    <line x1="8" y1="2" x2="8" y2="6"/>
                                </svg>
                                <div>
                                    <div class="text-sm text-gray-600">Activity Date</div>
                                    <div>{{ project.date.strftime('%Y-%m-%d') if project.date else 'TBD' }}</div>
                                </div>
                            </div>
                            <div class="flex items-start gap-3">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: var(--gray-500); margin-top: 0.125rem;">
                                    <circle cx="12" cy="12" r="10"/>
                                    <polyline points="12 6 12 12 16 14"/>
                                </svg>
                                <div>
                                    <div class="text-sm text-gray-600">Duration</div>
                                    <div>{{ project.duration }} hours</div>
                                </div>
                            </div>
                            <div class="flex items-start gap-3">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: var(--gray-500); margin-top: 0.125rem;">
                                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                                    <circle cx="12" cy="10" r="3"/>
                                </svg>
                                <div>
                                    <div class="text-sm text-gray-600">Location</div>
                                    <div>{{ project.location }}</div>
                                </div>
                            </div>
                            <div class="flex items-start gap-3">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: var(--gray-500); margin-top: 0.125rem;">
                                    <circle cx="12" cy="8" r="7"/>
                                    <polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/>
                                </svg>
                                <div>
                                    <div class="text-sm text-gray-600">Volunteer Points</div>
                                    <div>{{ project.points }} points</div>
                                </div>
                            </div>
                        </div>

                        <div>
                            <h3 class="mb-2">Requirements</h3>
                            <p class="text-gray-700">
                                {% if project.requirements %}
                                    {{ project.requirements }}
                                {% else %}
                                    No specific requirements listed.
                                {% endif %}
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Comments Section -->
                <div class="card">
                    <div class="card-header">
                        <h3 style="margin: 0;">Comments & Discussion</h3>
                        <p class="text-sm text-gray-600 mt-1">Participants and organizations can communicate here</p>
                    </div>
                    <div class="card-content">
                        <!-- Comment Input -->
                        <div class="mb-6">
                            <textarea id="comment-text" placeholder="Feel free to leave any questions here..." rows="3" style="margin-bottom: 0.75rem; width: 100%; padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: var(--border-radius);"></textarea>
                            <button class="btn btn-primary" onclick="submitComment({{ project.id }})">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 0.5rem;">
                                    <line x1="22" y1="2" x2="11" y2="13"/>
                                    <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                                </svg>
                                Send Comment
                            </button>
                        </div>

                        <!-- Comments List -->
                        <div style="display: flex; flex-direction: column; gap: 1rem;">
                            {% if comments %}
                                {% for comment in comments %}
                                <div style="border-left: 4px solid #dcfce7; padding-left: 1rem; padding-top: 0.5rem; padding-bottom: 0.5rem;">
                                    <div class="flex items-center gap-2 mb-2">
                                        <span>{{ comment.user_name }}</span>
                                        <span class="badge badge-secondary text-xs">{{ comment.user_type }}</span>
                                        <span class="text-xs text-gray-500">{{ comment.created_at }}</span>
                                    </div>
                                    <p class="text-gray-700 mb-2">{{ comment.comment }}</p>
                                    {% if comment.reply %}
                                    <div style="background-color: #eff6ff; padding: 0.75rem; border-radius: var(--border-radius); margin-top: 0.5rem;">
                                        <div class="flex items-center gap-2 mb-1">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: var(--secondary-blue);">
                                                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                                            </svg>
                                            <span class="text-sm" style="color: var(--secondary-blue);">Organization Reply:</span>
                                        </div>
                                        <p class="text-sm text-gray-700">{{ comment.reply }}</p>
                                    </div>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            {% else %}
                                <p class="text-gray-500 text-center py-4">No comments yet. Be the first to ask a question!</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div>
                <!-- Registration Card -->
                <div class="card mb-6">
                    <div class="card-content">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-gray-600">Registered</span>
                            <span>{{ registration_count or 0 }}/{{ project.max_participants }}</span>
                        </div>
                        <div class="progress-bar mb-4">
                            {% set progress = ((registration_count or 0) / project.max_participants * 100) | round(0) | int %}
                            <div class="progress-fill" style="width: {{ progress }}%;"></div>
                        </div>
                        {% if is_registered %}
                        <button class="btn" id="register-btn" style="width: 100%; background-color: #dcfce7; color: var(--primary-green);" disabled>
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 0.5rem;">
                                <polyline points="20 6 9 17 4 12"/>
                            </svg>
                            Already Registered
                        </button>
                        {% else %}
                        <button class="btn btn-primary" id="register-btn" style="width: 100%;" onclick="registerForProject({{ project.id }})">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 0.5rem;">
                                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                                <circle cx="9" cy="7" r="4"/>
                                <path d="M22 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/>
                            </svg>
                            Register Now
                        </button>
                        {% endif %}
                    </div>
                </div>

                <!-- Organizer Info -->
                <div class="card mb-6">
                    <div class="card-header">
                        <h3 style="margin: 0; font-size: 1rem;">Organization Info</h3>
                    </div>
                    <div class="card-content">
                        <div class="flex items-center gap-2 mb-3">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: var(--gray-500);">
                                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                            </svg>
                            <span>{{ (organization.display_name or organization.username) if organization else 'Organization Name' }}</span>
                        </div>
                        <p class="text-sm text-gray-600 mb-4">
                            {% if organization and organization.description %}
                                {{ organization.description }}
                            {% else %}
                                Organization description not available.
                            {% endif %}
                        </p>
                        <button class="btn btn-outline" style="width: 100%;">View More Projects</button>
                    </div>
                </div>

                <!-- Sustainability Info -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="flex items-center gap-2" style="margin: 0; font-size: 1rem;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 16v-4"/>
                                <path d="M12 8h.01"/>
                            </svg>
                            Sustainability Rating
                        </h3>
                    </div>
                    <div class="card-content">
                        <div class="mb-3">{{ render_stars(project.rating or 0.0, '16') }}</div>
                        <p class="text-sm text-gray-600 mb-4">
                            This project aligns with the UN Sustainable Development Goals (SDGs), having positive impacts on environmental protection and social development.
                        </p>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem; font-size: 0.875rem;">
                            <div class="flex items-center gap-2">
                                <div style="width: 0.5rem; height: 0.5rem; background-color: var(--primary-green); border-radius: 50%;"></div>
                                <span>Environmental Impact: ★★★★★</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div style="width: 0.5rem; height: 0.5rem; background-color: var(--primary-green); border-radius: 50%;"></div>
                                <span>Social Value: ★★★★☆</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div style="width: 0.5rem; height: 0.5rem; background-color: var(--primary-green); border-radius: 50%;"></div>
                                <span>Educational Significance: ★★★★★</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        async function registerForProject(projectId) {
            const btn = document.getElementById('register-btn');
            if (!btn) return;
            
            btn.disabled = true;
            btn.textContent = 'Registering...';
            
            try {
                const response = await fetch('/api/register-project', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ project_id: projectId })
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('Successfully registered for this project!');
                    btn.textContent = 'Registered';
                    btn.disabled = true;
                    btn.style.backgroundColor = '#dcfce7';
                    btn.style.color = 'var(--primary-green)';
                    // Reload page to update registration count
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    alert('Error: ' + (result.error || 'Failed to register'));
                    btn.disabled = false;
                    btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 0.5rem;"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/></svg>Register Now';
                }
            } catch (error) {
                console.error(error);
                alert('Error registering for project. Please try again.');
                btn.disabled = false;
                btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 0.5rem;"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/></svg>Register Now';
            }
        }
        
        async function submitComment(projectId) {
            const textarea = document.getElementById('comment-text');
            if (!textarea) return;
            
            const comment = textarea.value.trim();
            if (!comment) {
                alert('Please enter a comment.');
                return;
            }
            
            try {
                const response = await fetch(`/api/project/${projectId}/comment`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ comment: comment })
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('Comment submitted! (Note: Full comment system requires Comment model implementation)');
                    textarea.value = '';
                } else {
                    alert('Error: ' + (result.error || 'Failed to submit comment'));
                }
            } catch (error) {
                console.error(error);
                alert('Error submitting comment. Please try again.');
            }
        }
    </script>
</body>
</html>
